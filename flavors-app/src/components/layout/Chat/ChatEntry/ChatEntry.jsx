import "./ChatEntry.scss"
import { useState, useEffect } from 'react';
import { useMessages } from '@context/MessageContext';
import { wsUrl } from "@global/Variables";
import { useAuth } from "@context/AuthContext";

export default function ChatEntry({ userId }) {
  const { user } = useAuth()
  const youUserId = user.id
  
  const selectors = {
    form: `[data-js-form-entry]`,
    buttonSend: `[data-js-send]`,
  };

  const [inputValue, setInputValue] = useState("");
  // Используем контекст для управления сообщениями
  const { addMessage } = useMessages();

  // Состояние для WebSocket-сокета
  const [socket, setSocket] = useState(null);

  // Функция для обработки ввода текста
  const inputHandler = (event) => {
    const form = event.target.closest(selectors.form);
    const buttonSend = form.querySelector(selectors.buttonSend);
    if (event.target.value) {
      buttonSend.dataset.jsSend = "message";
    } else {
      buttonSend.dataset.jsSend = "voice";
    }
  };

  // Функция для отправки сообщения через WebSocket
  const handleSend = () => {
    if (!inputValue.trim()) return;

    // Отправляем сообщение через WebSocket
    if (socket && socket.readyState === WebSocket.OPEN) {
      const messageData = {
        sender_id: youUserId,
        receiver_id: userId, //  на реальный ID получателя
        text: inputValue,
      };
      socket.send(JSON.stringify(messageData));
    }
    // Добавляем сообщение в локальное состояние чата
    const formattedTime = new Date().toLocaleTimeString("ru-RU", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false, // 24-часовой формат
    });
    addMessage({
      type: "you",
      text: inputValue,
      sender: {
        id: youUserId
      },
      timestamp: formattedTime,
    });

    // Очищаем поле ввода
    setInputValue("");
  };

  // Установка соединения с WebSocket при монтировании компонента
  useEffect(() => {
    // Создаем WebSocket-соединение
    const chatSocket = new WebSocket(`${wsUrl}/ws/chat/${youUserId}/`);
    // Обработчик успешного подключения
    chatSocket.onopen = () => {
      console.log("Connected to WebSocket server");
    };
    // Обработчик получения сообщений
    chatSocket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log(data)
      // Добавляем полученное сообщение в локальное состояние чата
      addMessage({
        type: "other",
        text: data.text,
        sender: {
          id: data.sender.id
        },
        timestamp: data.timestamp
      });
    };

    // Обработчик ошибок
    chatSocket.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    // Обработчик закрытия соединения
    chatSocket.onclose = () => {
      console.log("WebSocket connection closed");
    };

    // Сохраняем сокет в состоянии
    setSocket(chatSocket);

    // Закрываем соединение при размонтировании компонента
    return () => {
      chatSocket.close();
    };
  }, [userId]);

  // Обработка нажатия клавиши Enter
  useEffect(() => {
    const handleKeyDown = (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        handleSend();
      }
    };

    document.addEventListener("keydown", handleKeyDown);

    // Удаляем слушатель при размонтировании компонента
    return () => {
      document.removeEventListener("keydown", handleKeyDown);
    };
  }, [inputValue]);

  return (
    <form action="" className="chat-entry padding" data-js-form-entry>
      <div className="chat-entry__entry border-radius-layout__base">
        <button type="button" id="fileSend" className="chat-entry__button">
          <svg width="28" height="32" viewBox="0 0 28 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M24.9635 3.06365C21.0998 -0.800025 14.808 -0.800025 10.9484 3.06365L0.243337 13.7605C0.17361 13.8302 0.136696 13.9246 0.136696 14.023C0.136696 14.1215 0.17361 14.2158 0.243337 14.2855L1.75681 15.799C1.82599 15.8679 1.91964 15.9065 2.01726 15.9065C2.11488 15.9065 2.20853 15.8679 2.27771 15.799L12.9828 5.10212C14.3117 3.77322 16.0795 3.04314 17.958 3.04314C19.8365 3.04314 21.6043 3.77322 22.9291 5.10212C24.258 6.43103 24.9881 8.1988 24.9881 10.0732C24.9881 11.9517 24.258 13.7154 22.9291 15.0443L12.0189 25.9504L10.2511 27.7181C8.59822 29.3711 5.9117 29.3711 4.25877 27.7181C3.45896 26.9183 3.02009 25.856 3.02009 24.724C3.02009 23.592 3.45896 22.5297 4.25877 21.7299L15.0828 10.9099C15.3576 10.6392 15.7185 10.4875 16.1041 10.4875H16.1082C16.4937 10.4875 16.8506 10.6392 17.1213 10.9099C17.3961 11.1847 17.5437 11.5457 17.5437 11.9312C17.5437 12.3127 17.392 12.6736 17.1213 12.9443L8.2742 21.7832C8.20447 21.8529 8.16755 21.9472 8.16755 22.0457C8.16755 22.1441 8.20447 22.2385 8.2742 22.3082L9.78767 23.8217C9.85685 23.8905 9.9505 23.9292 10.0481 23.9292C10.1457 23.9292 10.2394 23.8905 10.3086 23.8217L19.1515 14.9787C19.9677 14.1625 20.4148 13.0797 20.4148 11.9271C20.4148 10.7746 19.9636 9.68767 19.1515 8.87556C17.4658 7.18982 14.726 7.19392 13.0402 8.87556L11.9902 9.92966L2.22029 19.6955C1.55719 20.3547 1.03157 21.139 0.673899 22.0029C0.31623 22.8668 0.133632 23.7931 0.136696 24.7281C0.136696 26.6271 0.879079 28.4113 2.22029 29.7525C3.61072 31.1388 5.43181 31.832 7.25291 31.832C9.074 31.832 10.8951 31.1388 12.2814 29.7525L24.9635 17.0787C26.8297 15.2084 27.8633 12.7187 27.8633 10.0732C27.8674 7.42361 26.8338 4.93396 24.9635 3.06365Z" fill="white" />
          </svg>
          <span className="visually-hidden">
            Отправить файлы
          </span>
        </button>
        <input
          type="text"
          name="sendText"
          id="sendText"
          placeholder="Type your message here..."
          data-js-text=""
          value={inputValue}
          onChange={(event) => setInputValue(event.target.value)}
          onInput={(event) => inputHandler(event)} />
        <button type="button" className="chat-entry__button">
          <svg width="33" height="33" viewBox="0 0 33 33" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.125 11.125C10.7686 11.125 10.4268 11.2666 10.1748 11.5186C9.92282 11.7706 9.78125 12.1124 9.78125 12.4688C9.78125 12.8251 9.63968 13.1669 9.38767 13.4189C9.13567 13.6709 8.79388 13.8125 8.4375 13.8125C8.08112 13.8125 7.73933 13.6709 7.48733 13.4189C7.23532 13.1669 7.09375 12.8251 7.09375 12.4688C7.09375 11.3996 7.51847 10.3742 8.27448 9.61823C9.03048 8.86222 10.0558 8.4375 11.125 8.4375C12.1942 8.4375 13.2195 8.86222 13.9755 9.61823C14.7315 10.3742 15.1562 11.3996 15.1562 12.4688C15.1562 12.8251 15.0147 13.1669 14.7627 13.4189C14.5107 13.6709 14.1689 13.8125 13.8125 13.8125C13.4561 13.8125 13.1143 13.6709 12.8623 13.4189C12.6103 13.1669 12.4688 12.8251 12.4688 12.4688C12.4688 12.1124 12.3272 11.7706 12.0752 11.5186C11.8232 11.2666 11.4814 11.125 11.125 11.125ZM21.875 11.125C21.5186 11.125 21.1768 11.2666 20.9248 11.5186C20.6728 11.7706 20.5312 12.1124 20.5312 12.4688C20.5312 12.8251 20.3897 13.1669 20.1377 13.4189C19.8857 13.6709 19.5439 13.8125 19.1875 13.8125C18.8311 13.8125 18.4893 13.6709 18.2373 13.4189C17.9853 13.1669 17.8438 12.8251 17.8438 12.4688C17.8438 11.3996 18.2685 10.3742 19.0245 9.61823C19.7805 8.86222 20.8058 8.4375 21.875 8.4375C22.9442 8.4375 23.9695 8.86222 24.7255 9.61823C25.4815 10.3742 25.9062 11.3996 25.9062 12.4688C25.9062 12.8251 25.7647 13.1669 25.5127 13.4189C25.2607 13.6709 24.9189 13.8125 24.5625 13.8125C24.2061 13.8125 23.8643 13.6709 23.6123 13.4189C23.3603 13.1669 23.2188 12.8251 23.2188 12.4688C23.2188 12.1124 23.0772 11.7706 22.8252 11.5186C22.5732 11.2666 22.2314 11.125 21.875 11.125ZM7.18781 16.5C6.99547 16.5 6.80538 16.5413 6.63038 16.6212C6.45538 16.701 6.29956 16.8174 6.17344 16.9627C6.04732 17.1079 5.95385 17.2785 5.89935 17.463C5.84484 17.6474 5.83057 17.8414 5.8575 18.0319C6.22263 20.5943 7.50005 22.939 9.45513 24.6353C11.4102 26.3315 13.9117 27.2654 16.5 27.2654C19.0883 27.2654 21.5898 26.3315 23.5449 24.6353C25.4999 22.939 26.7774 20.5943 27.1425 18.0319C27.1695 17.8412 27.1551 17.647 27.1005 17.4623C27.0458 17.2777 26.9521 17.1069 26.8257 16.9617C26.6993 16.8164 26.5431 16.7 26.3678 16.6203C26.1925 16.5407 26.0021 16.4996 25.8095 16.5H7.18781ZM16.5 24.5625C14.8322 24.5626 13.2053 24.0458 11.8433 23.0832C10.4813 22.1207 9.45105 20.7597 8.89437 19.1875H24.1056C23.5489 20.7597 22.5187 22.1207 21.1567 23.0832C19.7947 24.0458 18.1678 24.5626 16.5 24.5625ZM32.625 16.5C32.625 14.3824 32.2079 12.2856 31.3976 10.3292C30.5872 8.37285 29.3994 6.59525 27.9021 5.0979C26.4048 3.60056 24.6271 2.4128 22.6708 1.60244C20.7144 0.792086 18.6176 0.375 16.5 0.375C14.3824 0.375 12.2856 0.792086 10.3292 1.60244C8.37285 2.4128 6.59525 3.60056 5.0979 5.0979C3.60056 6.59525 2.4128 8.37285 1.60244 10.3292C0.792085 12.2856 0.375 14.3824 0.375 16.5C0.375 20.7766 2.07388 24.8781 5.0979 27.9021C8.12193 30.9261 12.2234 32.625 16.5 32.625C20.7766 32.625 24.8781 30.9261 27.9021 27.9021C30.9261 24.8781 32.625 20.7766 32.625 16.5ZM3.0625 16.5C3.0625 12.9362 4.47823 9.51827 6.99825 6.99825C9.51827 4.47823 12.9362 3.0625 16.5 3.0625C20.0638 3.0625 23.4817 4.47823 26.0017 6.99825C28.5218 9.51827 29.9375 12.9362 29.9375 16.5C29.9375 20.0638 28.5218 23.4817 26.0017 26.0017C23.4817 28.5218 20.0638 29.9375 16.5 29.9375C12.9362 29.9375 9.51827 28.5218 6.99825 26.0017C4.47823 23.4817 3.0625 20.0638 3.0625 16.5Z" fill="white" />
          </svg>
          <span htmlFor="emogies" className="visually-hidden">
            Emogies
          </span>
        </button>
        <button type="button" id="photoSend" className="chat-entry__button">
          <svg width="32" height="31" viewBox="0 0 32 31" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.0479 0.964657C19.6686 0.964607 20.2786 1.12675 20.8174 1.43502C21.3562 1.74329 21.805 2.18699 22.1195 2.72216L23.4084 4.91824H26.6875C28.0519 4.91824 29.3606 5.46017 30.3256 6.42486C31.2905 7.38955 31.8329 8.698 31.8333 10.0625V25.1042C31.8333 25.7799 31.7002 26.4491 31.4416 27.0734C31.183 27.6977 30.804 28.265 30.3261 28.7428C29.8483 29.2206 29.281 29.5997 28.6567 29.8583C28.0324 30.1169 27.3632 30.25 26.6875 30.25H5.31246C3.9477 30.25 2.63884 29.7078 1.67381 28.7428C0.708775 27.7778 0.166626 26.4689 0.166626 25.1042V10.0625C0.166626 8.69773 0.708775 7.38887 1.67381 6.42384C2.63884 5.45881 3.9477 4.91666 5.31246 4.91666H8.60579L9.99121 2.66199C10.3098 2.143 10.756 1.71434 11.2874 1.41691C11.8188 1.11949 12.4175 0.963235 13.0265 0.963074H19.0479V0.964657ZM19.0479 3.33966H13.0265C12.8532 3.3398 12.682 3.37786 12.525 3.45116C12.368 3.52446 12.229 3.63124 12.1176 3.76399L12.0147 3.90649L10.2841 6.72482C10.178 6.89792 10.0293 7.04091 9.85215 7.14015C9.67502 7.23938 9.47541 7.29155 9.27238 7.29166H5.31404C4.95004 7.29145 4.58956 7.36297 4.2532 7.50212C3.91685 7.64127 3.61121 7.84534 3.35374 8.10266C3.09628 8.35997 2.89204 8.6655 2.75269 9.00177C2.61335 9.33805 2.54163 9.69849 2.54163 10.0625V25.1042C2.54163 26.6337 3.78296 27.875 5.31246 27.875H26.6875C27.4223 27.875 28.1271 27.5831 28.6467 27.0634C29.1664 26.5438 29.4583 25.839 29.4583 25.1042V10.0625C29.4583 9.32762 29.1664 8.62285 28.6467 8.10322C28.1271 7.58358 27.4223 7.29166 26.6875 7.29166H22.7291C22.5221 7.29177 22.3187 7.23776 22.139 7.135C21.9593 7.03224 21.8096 6.88429 21.7047 6.70582L20.0707 3.92391C19.966 3.74567 19.8165 3.59787 19.6371 3.49512C19.4577 3.39238 19.2546 3.33824 19.0479 3.33807V3.33966ZM16 9.66666C17.8896 9.66666 19.7019 10.4173 21.0381 11.7535C22.3743 13.0897 23.125 14.902 23.125 16.7917C23.125 18.6813 22.3743 20.4936 21.0381 21.8298C19.7019 23.166 17.8896 23.9167 16 23.9167C14.1103 23.9167 12.298 23.166 10.9618 21.8298C9.62563 20.4936 8.87496 18.6813 8.87496 16.7917C8.87496 14.902 9.62563 13.0897 10.9618 11.7535C12.298 10.4173 14.1103 9.66666 16 9.66666ZM16 12.0417C15.3762 12.0417 14.7585 12.1645 14.1822 12.4032C13.6059 12.6419 13.0823 12.9918 12.6412 13.4329C12.2001 13.874 11.8502 14.3976 11.6115 14.9739C11.3728 15.5502 11.25 16.1679 11.25 16.7917C11.25 17.4154 11.3728 18.0331 11.6115 18.6094C11.8502 19.1857 12.2001 19.7093 12.6412 20.1504C13.0823 20.5915 13.6059 20.9414 14.1822 21.1801C14.7585 21.4188 15.3762 21.5417 16 21.5417C17.2597 21.5417 18.4679 21.0412 19.3587 20.1504C20.2495 19.2596 20.75 18.0514 20.75 16.7917C20.75 15.5319 20.2495 14.3237 19.3587 13.4329C18.4679 12.5421 17.2597 12.0417 16 12.0417Z" fill="white" />
          </svg>
          <span className="visually-hidden">
            Отправить файлы
          </span>
        </button>
      </div>
      <div className="chat-entry__entry border-radius-layout__base">
        <button type="button" className="chat-entry__button" data-js-send="voice" onClick={handleSend}>
          <svg width="24" height="38" viewBox="0 0 24 38" fill="none" xmlns="http://www.w3.org/2000/svg" className="microphone">
            <path d="M4.875 7.125C4.875 5.23533 5.62567 3.42306 6.96186 2.08686C8.29806 0.750668 10.1103 0 12 0C13.8897 0 15.7019 0.750668 17.0381 2.08686C18.3743 3.42306 19.125 5.23533 19.125 7.125V19C19.125 20.8897 18.3743 22.7019 17.0381 24.0381C15.7019 25.3743 13.8897 26.125 12 26.125C10.1103 26.125 8.29806 25.3743 6.96186 24.0381C5.62567 22.7019 4.875 20.8897 4.875 19V7.125Z" fill="white" />
            <path d="M1.3125 15.4375C1.62744 15.4375 1.92949 15.5626 2.15219 15.7853C2.37489 16.008 2.5 16.3101 2.5 16.625V19C2.5 21.5196 3.50089 23.9359 5.28249 25.7175C7.06408 27.4991 9.48044 28.5 12 28.5C14.5196 28.5 16.9359 27.4991 18.7175 25.7175C20.4991 23.9359 21.5 21.5196 21.5 19V16.625C21.5 16.3101 21.6251 16.008 21.8478 15.7853C22.0705 15.5626 22.3726 15.4375 22.6875 15.4375C23.0024 15.4375 23.3045 15.5626 23.5272 15.7853C23.7499 16.008 23.875 16.3101 23.875 16.625V19C23.875 21.9439 22.7816 24.7828 20.8068 26.9661C18.832 29.1493 16.1166 30.5212 13.1875 30.8156V35.625H20.3125C20.6274 35.625 20.9295 35.7501 21.1522 35.9728C21.3749 36.1955 21.5 36.4976 21.5 36.8125C21.5 37.1274 21.3749 37.4295 21.1522 37.6522C20.9295 37.8749 20.6274 38 20.3125 38H3.6875C3.37256 38 3.07051 37.8749 2.84781 37.6522C2.62511 37.4295 2.5 37.1274 2.5 36.8125C2.5 36.4976 2.62511 36.1955 2.84781 35.9728C3.07051 35.7501 3.37256 35.625 3.6875 35.625H10.8125V30.8156C7.88338 30.5212 5.16802 29.1493 3.19321 26.9661C1.21841 24.7828 0.124963 21.9439 0.125 19V16.625C0.125 16.3101 0.250111 16.008 0.472811 15.7853C0.69551 15.5626 0.997555 15.4375 1.3125 15.4375Z" fill="white" />
          </svg>
          <svg width="34" height="27" viewBox="0 0 34 27" fill="none" xmlns="http://www.w3.org/2000/svg" className="send">
            <path d="M17.0001 18.8269C17.0001 19.2338 16.7535 19.6002 16.3764 19.7533L2.70643 25.3068C1.97151 25.6053 1.19818 24.9703 1.34807 24.1913L3.36893 13.6889C3.39294 13.5641 3.39294 13.4359 3.36893 13.311L1.33709 2.75157C1.18951 1.98457 1.93886 1.35204 2.6702 1.62629L16.3512 6.75666C16.7415 6.90302 17.0001 7.27614 17.0001 7.69299V18.8269Z" fill="white" />
            <path d="M31.635 14.4367L17.8503 19.5864C17.9474 19.3499 18.0001 19.0927 18.0001 18.8269V7.69299C18.0001 7.61602 17.9956 7.53979 17.987 7.4646L31.635 12.5632C32.5017 12.887 32.5018 14.1129 31.635 14.4367ZM2.33006 24.3803L3.36581 18.9975L5.12733 14.6199C5.4165 13.9013 5.4165 13.0987 5.12733 12.3801L3.3658 8.00247L2.31908 2.56262L16.0001 7.69299V18.8269L2.33006 24.3803Z" stroke="white" strokeWidth="2" />
          </svg>
        </button>
      </div>
    </form>
  )
}